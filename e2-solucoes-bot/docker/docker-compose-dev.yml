# ============================================================================
# E2 Soluções Bot - Docker Compose DEVELOPMENT
# ============================================================================
#
# Configuração minimalista para desenvolvimento local do Sprint 1.1
#
# Uso:
#   docker-compose -f docker/docker-compose-dev.yml up -d
#   docker-compose -f docker/docker-compose-dev.yml down
#
# Acesso:
#   n8n: http://localhost:5678 (sem autenticação)
#
# ============================================================================

version: '3.8'

services:
  # ============================================================================
  # n8n - Workflow Automation (Sprint 1.1)
  # ============================================================================
  n8n-dev:
    image: n8nio/n8n:latest
    container_name: e2bot-n8n-dev
    restart: unless-stopped

    ports:
      - "5678:5678"

    environment:
      # === Development Configuration ===
      - NODE_ENV=development
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_HOST=localhost

      # === No Authentication (Dev Only) ===
      - N8N_BASIC_AUTH_ACTIVE=false

      # === Webhooks ===
      - WEBHOOK_URL=http://localhost:5678/

      # === Timezone ===
      - GENERIC_TIMEZONE=America/Sao_Paulo

      # === Logging ===
      - N8N_LOG_LEVEL=debug
      - N8N_LOG_OUTPUT=console

      # === Sprint 1.1 Credentials (do .env) ===
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}

      # === Performance (Dev) ===
      - N8N_PAYLOAD_SIZE_MAX=16
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true

    volumes:
      # Dados persistentes do n8n
      - n8n_dev_data:/home/node/.n8n

      # Workflows (read-only para preservar originais)
      - ../n8n/workflows:/workflows:ro

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - e2bot-dev

  # ============================================================================
  # PostgreSQL - Evolution API Database
  # ============================================================================
  evolution-postgres:
    image: postgres:15-alpine
    container_name: e2bot-evolution-postgres
    restart: unless-stopped

    environment:
      - POSTGRES_USER=evolution
      - POSTGRES_PASSWORD=evolution_dev_password
      - POSTGRES_DB=evolution

    volumes:
      - evolution_postgres_data:/var/lib/postgresql/data

    networks:
      - e2bot-dev

  # ============================================================================
  # Evolution API - WhatsApp Integration (Sprint 0.1)
  # ============================================================================
  evolution-api:
    image: atendai/evolution-api:v2.2.3
    container_name: e2bot-evolution-dev
    restart: unless-stopped
    depends_on:
      - evolution-postgres
      - evolution-redis

    ports:
      - "8080:8080"

    env_file:
      - .env

    environment:
      # === Server Configuration ===
      - SERVER_TYPE=http
      - SERVER_PORT=8080
      - SERVER_URL=http://localhost:8080

      # === Authentication ===
      - AUTHENTICATION_TYPE=apikey
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY}
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true

      # === Database Configuration ===
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://evolution:evolution_dev_password@evolution-postgres:5432/evolution
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_MESSAGE_UPDATE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true

      # === Redis Configuration ===
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://evolution-redis:6379
      - CACHE_REDIS_PREFIX_KEY=evolution
      - CACHE_REDIS_SAVE_INSTANCES=true
      - CACHE_LOCAL_ENABLED=false

      # === Webhook Global (n8n) ===
      - WEBHOOK_GLOBAL_URL=http://n8n-dev:5678/webhook/whatsapp-messages
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=true

      # === Webhook Events ===
      - WEBHOOK_EVENTS_APPLICATION_STARTUP=false
      - WEBHOOK_EVENTS_QRCODE_UPDATED=true
      - WEBHOOK_EVENTS_MESSAGES_SET=true
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - WEBHOOK_EVENTS_MESSAGES_UPDATE=true
      - WEBHOOK_EVENTS_MESSAGES_DELETE=false
      - WEBHOOK_EVENTS_SEND_MESSAGE=false
      - WEBHOOK_EVENTS_CONNECTION_UPDATE=true

      # === Logging ===
      - LOG_LEVEL=ERROR
      - LOG_COLOR=true
      - LOG_BAILEYS=error

    volumes:
      # Dados da instância WhatsApp (persistente)
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - e2bot-dev

  # ============================================================================
  # Redis - Cache for Evolution API v2.x
  # ============================================================================
  evolution-redis:
    image: redis:7-alpine
    container_name: e2bot-evolution-redis
    restart: unless-stopped

    command: redis-server --appendonly yes

    volumes:
      - evolution_redis_data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - e2bot-dev

# ============================================================================
# Volumes
# ============================================================================
volumes:
  n8n_dev_data:
    driver: local
    name: e2bot_n8n_dev_data

  evolution_postgres_data:
    driver: local
    name: e2bot_evolution_postgres_data

  evolution_instances:
    driver: local
    name: e2bot_evolution_instances

  evolution_store:
    driver: local
    name: e2bot_evolution_store

  evolution_redis_data:
    driver: local
    name: e2bot_evolution_redis_data

# ============================================================================
# Networks
# ============================================================================
networks:
  e2bot-dev:
    driver: bridge
    name: e2bot-dev-network
